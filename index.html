 <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Incidencias</title>
  <!-- Enlace a los estilos de Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Enlace a las librerías jsPDF y jsPDF-autoTable para la exportación -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <!-- Enlace a los iconos de Lucide React -->
  <script type="module">
    import { createElement as r, useState, useMemo, useRef, useEffect, Fragment } from 'https://esm.sh/react@18.2.0';
    import { createRoot as d } from 'https://esm.sh/react-dom@18.2.0/client';
    import { PlusCircle, Search, Trash2, FileText, Loader2, XCircle, Edit } from 'https://esm.sh/lucide-react@0.292.0';

    // A continuación se encuentra el código de la aplicación de React
    const App = () => {
      // Estado para guardar los datos del formulario actual
      const [formData, setFormData] = useState({
        fecha: new Date().toISOString().slice(0, 10), // Fecha actual por defecto
        nivel: 'PRIMARIA 1A', // Valor por defecto actualizado
        tipo: 'LIBRO', // Valor por defecto actualizado a 'LIBRO'
        incidencias: '',
      });
    
      // Estado para guardar todas las entradas de la tabla
      const [entries, setEntries] = useState([]);
      
      // Estado para la barra de búsqueda
      const [searchQuery, setSearchQuery] = useState('');
    
      // Estado para mostrar mensajes de validación
      const [validationError, setValidationError] = useState('');
    
      // Estado para el indicador de carga del PDF
      const [isExporting, setIsExporting] = useState(false);
      // Nuevo estado para manejar errores de exportación
      const [exportError, setExportError] = useState('');

      // Estado para el indicador de carga de la base de datos
      const [isLoading, setIsLoading] = useState(true);

      // Nuevo estado para controlar el modo de edición
      const [editingEntryId, setEditingEntryId] = useState(null);

      // Función para formatear el texto: la primera letra de cada oración en mayúscula
      const formatIncidenciaText = (text) => {
        // Convierte todo a minúsculas para un formato consistente
        const lowercased = text.toLowerCase();
        // Divide el texto por puntos y espacios
        const sentences = lowercased.split('. ');
        
        // Mapea cada oración para capitalizar la primera letra
        const formattedSentences = sentences.map(sentence => {
          if (sentence.length > 0) {
            // Capitaliza la primera letra y concatena el resto de la oración
            return sentence.charAt(0).toUpperCase() + sentence.slice(1);
          }
          return sentence;
        });
        
        // Une las oraciones de nuevo con un punto y espacio
        return formattedSentences.join('. ');
      };


      // Cargar registros desde el almacenamiento local al inicio
      useEffect(() => {
        try {
          const savedEntries = localStorage.getItem('incidencias_registros');
          if (savedEntries) {
            // Ordenamos los registros por fecha en memoria, de más reciente a más antiguo
            const parsedEntries = JSON.parse(savedEntries);
            parsedEntries.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            setEntries(parsedEntries);
          }
        } catch (error) {
          console.error("Error al cargar los datos del almacenamiento local:", error);
          // Si hay un error, se inicializa con un array vacío
          setEntries([]);
        } finally {
          setIsLoading(false);
        }
      }, []);

      // Guardar registros en el almacenamiento local cada vez que cambian
      useEffect(() => {
        if (entries.length > 0) {
          localStorage.setItem('incidencias_registros', JSON.stringify(entries));
        } else if (entries.length === 0 && !isLoading) {
          // Si el array está vacío y ya se ha cargado, se borra el local storage
          localStorage.removeItem('incidencias_registros');
        }
      }, [entries, isLoading]);
    
      // Maneja los cambios en los campos del formulario
      const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData((prevData) => ({ ...prevData, [name]: value }));
      };
    
      // Maneja el envío del formulario para agregar una nueva entrada
      const handleSubmit = (e) => {
        e.preventDefault();
        if (!formData.incidencias) {
          setValidationError('Por favor, ingresa el campo de incidencias.');
          return;
        }
        setValidationError(''); // Limpia el error si la entrada es válida
        
        // Si estamos en modo de edición, actualizamos el registro
        if (editingEntryId) {
          handleUpdate();
          return;
        }

        // Formatea el texto de la incidencia antes de guardarlo
        const formattedIncidencia = formatIncidenciaText(formData.incidencias);

        // Crea un objeto para la nueva entrada con un ID único
        const newEntry = {
          id: new Date().getTime().toString(),
          fecha: formData.fecha,
          nivel: formData.nivel,
          tipo: formData.tipo,
          incidencias: formattedIncidencia,
        };

        setEntries((prevEntries) => {
          // Agrega la nueva entrada al array de registros
          const updatedEntries = [...prevEntries, newEntry];
          // Ordena los registros por fecha, de más reciente a más antiguo
          updatedEntries.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          return updatedEntries;
        });

        // Reinicia el formulario, manteniendo la fecha actual
        setFormData({
          fecha: new Date().toISOString().slice(0, 10),
          nivel: 'PRIMARIA 1A',
          tipo: 'LIBRO',
          incidencias: '',
        });
      };

      // Función para actualizar un registro existente
      const handleUpdate = () => {
        // Formatea el texto de la incidencia antes de actualizarlo
        const formattedIncidencia = formatIncidenciaText(formData.incidencias);

        setEntries((prevEntries) => {
          const updatedEntries = prevEntries.map(entry =>
            entry.id === editingEntryId
              ? { ...entry, ...formData, incidencias: formattedIncidencia }
              : entry
          );
          updatedEntries.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
          return updatedEntries;
        });
        
        // Finaliza el modo de edición y limpia el formulario
        setEditingEntryId(null);
        setFormData({
          fecha: new Date().toISOString().slice(0, 10),
          nivel: 'PRIMARIA 1A',
          tipo: 'LIBRO',
          incidencias: '',
        });
      };

      // Inicia el modo de edición para un registro
      const handleEdit = (entry) => {
        setEditingEntryId(entry.id);
        setFormData({
          fecha: entry.fecha,
          nivel: entry.nivel,
          tipo: entry.tipo,
          incidencias: entry.incidencias
        });
      };

      // Cancela el modo de edición
      const handleCancelEdit = () => {
        setEditingEntryId(null);
        setFormData({
          fecha: new Date().toISOString().slice(0, 10),
          nivel: 'PRIMARIA 1A',
          tipo: 'LIBRO',
          incidencias: '',
        });
      };
      
      // Filtra las entradas de la tabla basadas en el texto de búsqueda
      const filteredEntries = useMemo(() => {
        if (!searchQuery) {
          return entries;
        }
        const lowercasedQuery = searchQuery.toLowerCase();
        return entries.filter(entry =>
          entry.fecha.includes(lowercasedQuery) ||
          entry.nivel.toLowerCase().includes(lowercasedQuery) ||
          entry.tipo.toLowerCase().includes(lowercasedQuery) ||
          entry.incidencias.toLowerCase().includes(lowercasedQuery)
        );
      }, [entries, searchQuery]);
    
      // Maneja la eliminación de una entrada
      const handleDelete = (id) => {
        setEntries((prevEntries) => prevEntries.filter(entry => entry.id !== id));
      };
    
      // Función para exportar la tabla a PDF usando jsPDF
      const handleExportPdf = () => {
        // Asegurarse de que las librerías estén cargadas
        if (typeof window.jspdf === 'undefined') {
          console.error("Librería jsPDF no cargada.");
          setExportError('Error: La librería de exportación a PDF no se ha cargado correctamente.');
          return;
        }
        
        if (filteredEntries.length === 0) {
          setExportError('No hay registros filtrados para exportar a PDF.');
          return;
        }
        
        setIsExporting(true);
        setExportError('');

        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          
          // Título del documento
          doc.setFontSize(18);
          doc.text("Registro de Incidencias", 14, 20);

          // Definir las columnas y los datos de la tabla
          const headers = [["Fecha", "Nivel", "Tipo", "Incidencias"]];
          const data = filteredEntries.map(entry => [entry.fecha, entry.nivel, entry.tipo, entry.incidencias]);
          
          // Generar la tabla con jsPDF-autoTable
          doc.autoTable({
            startY: 30, // Posición vertical inicial
            head: headers,
            body: data,
            theme: 'striped',
            headStyles: { fillColor: [242, 242, 242], textColor: [0, 0, 0] },
            styles: {
              font: "Helvetica",
              fontSize: 10,
              cellPadding: 3,
              overflow: 'linebreak',
              valign: 'middle'
            },
            columnStyles: {
              3: { cellWidth: 80 } // Ancho de la columna de incidencias
            }
          });

          // Guardar el PDF
          doc.save(`registros_incidencias_${new Date().toISOString().slice(0, 10)}.pdf`);
          
          setIsExporting(false);
        } catch (error) {
          console.error("Error al exportar a PDF:", error);
          setExportError('Ocurrió un error al generar el PDF. Inténtalo de nuevo.');
          setIsExporting(false);
        }
      };
      
      // Función para establecer el texto de incidencias con un valor predefinido
      const handlePredefinedIncidencia = (text) => {
        setFormData(prevData => ({ ...prevData, incidencias: text }));
      };
    
      // Componente JSX principal
      return (
        r('div', { className: 'min-h-screen bg-slate-50 p-4 sm:p-8 font-sans' },
          r('div', { className: 'max-w-4xl mx-auto space-y-8' },
            // Título y descripción
            r('div', { className: 'text-center' },
              r('h1', { className: 'text-4xl sm:text-5xl font-bold text-gray-800 tracking-tight mb-2' }, 'Registro de Incidencias'),
              r('p', { className: 'text-gray-500 text-lg' }, 'Introduce y gestiona las incidencias por día.')
            ),
            
            // Sección de formulario
            r('div', { className: 'bg-white rounded-2xl shadow-xl p-6 sm:p-8 transition-all duration-300 hover:shadow-2xl' },
              r('h2', { className: 'text-2xl font-semibold text-gray-700 mb-6' },
                editingEntryId ? 'Editar Registro' : 'Nuevo Registro'
              ),
              r('form', { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                // Campo Fecha
                r('div', null,
                  r('label', { htmlFor: 'fecha', className: 'block text-sm font-medium text-gray-600 mb-1' }, 'Fecha'),
                  r('input', {
                    type: 'date',
                    id: 'fecha',
                    name: 'fecha',
                    value: formData.fecha,
                    onChange: handleChange,
                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors',
                    required: true
                  })
                ),
                
                // Campo Nivel
                r('div', null,
                  r('label', { htmlFor: 'nivel', className: 'block text-sm font-medium text-gray-600 mb-1' }, 'Nivel'),
                  r('select', {
                    id: 'nivel',
                    name: 'nivel',
                    value: formData.nivel,
                    onChange: handleChange,
                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors',
                    required: true
                  },
                    r('option', { value: 'PRIMARIA 1A' }, 'PRIMARIA 1A'),
                    r('option', { value: 'PRIMARIA 1B' }, 'PRIMARIA 1B'),
                    r('option', { value: 'PRIMARIA 1C' }, 'PRIMARIA 1C'),
                    r('option', { value: 'PRIMARIA 2E' }, 'PRIMARIA 2E'),
                    r('option', { value: 'PRIMARIA 2F' }, 'PRIMARIA 2F'),
                    r('option', { value: 'PRIMARIA 2G' }, 'PRIMARIA 2G'),
                    r('option', { value: 'PRIMARIA 3H' }, 'PRIMARIA 3H'),
                    r('option', { value: 'PRIMARIA 3I' }, 'PRIMARIA 3I'),
                    r('option', { value: 'PRIMARIA 3J' }, 'PRIMARIA 3J'),
                    r('option', { value: 'PRIMARIA 4K' }, 'PRIMARIA 4K'),
                    r('option', { value: 'PRIMARIA 4L' }, 'PRIMARIA 4L'),
                    r('option', { value: 'PRIMARIA 4M' }, 'PRIMARIA 4M'),
                    r('option', { value: 'PRIMARIA 5N' }, 'PRIMARIA 5N'),
                    r('option', { value: 'PRIMARIA 5O' }, 'PRIMARIA 5O'),
                    r('option', { value: 'PRIMARIA 5P' }, 'PRIMARIA 5P'),
                    r('option', { value: 'PRIMARIA 6Q' }, 'PRIMARIA 6Q'),
                    r('option', { value: 'PRIMARIA 6R' }, 'PRIMARIA 6R'),
                    r('option', { value: 'PRIMARIA 6S' }, 'PRIMARIA 6S'),
                    r('option', { value: 'SECUNDARIA 1A' }, 'SECUNDARIA 1A'),
                    r('option', { value: 'SECUNDARIA 1B' }, 'SECUNDARIA 1B'),
                    r('option', { value: 'SECUNDARIA 1C' }, 'SECUNDARIA 1C'),
                    r('option', { value: 'SECUNDARIA 2D' }, 'SECUNDARIA 2D'),
                    r('option', { value: 'SECUNDARIA 2E' }, 'SECUNDARIA 2E'),
                    r('option', { value: 'SECUNDARIA 2F' }, 'SECUNDARIA 2F'),
                    r('option', { value: 'SECUNDARIA 3G' }, 'SECUNDARIA 3G'),
                    r('option', { value: 'SECUNDARIA 3H' }, 'SECUNDARIA 3H'),
                    r('option', { value: 'SECUNDARIA 3I' }, 'SECUNDARIA 3I')
                  )
                ),
                
                // Campo Tipo
                r('div', null,
                  r('label', { htmlFor: 'tipo', className: 'block text-sm font-medium text-gray-600 mb-1' }, 'Tipo'),
                  r('select', {
                    id: 'tipo',
                    name: 'tipo',
                    value: formData.tipo,
                    onChange: handleChange,
                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors',
                    required: true
                  },
                    r('option', { value: 'LIBRO' }, 'LIBRO'),
                    r('option', { value: 'TALLER' }, 'TALLER')
                  )
                ),
                
                // Campo Incidencias
                r('div', { className: 'md:col-span-2' },
                  r('label', { htmlFor: 'incidencias', className: 'block text-sm font-medium text-gray-600 mb-1' }, 'Incidencias'),
                  r('textarea', {
                    id: 'incidencias',
                    name: 'incidencias',
                    value: formData.incidencias,
                    onChange: handleChange,
                    rows: '4',
                    className: 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors resize-none',
                    placeholder: 'Escribe aquí las incidencias...',
                    required: true
                  }),
                  // Botones de recomendaciones para incidencias
                  r('div', { className: 'flex flex-wrap gap-2 mt-2' },
                    r('button', {
                      type: 'button',
                      onClick: () => handlePredefinedIncidencia('SIN INCIDENCIAS'),
                      className: 'px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors'
                    }, 'SIN INCIDENCIAS'),
                    r('button', {
                      type: 'button',
                      onClick: () => handlePredefinedIncidencia('LAS CLASES SE DESARROLLÓ EN EL AULA'),
                      className: 'px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors'
                    }, 'LAS CLASES SE DESARROLLÓ EN EL AULA')
                  ),
                  validationError && r('p', { className: 'mt-1 text-sm text-red-500' }, validationError)
                ),
                
                // Botones de envío/actualización
                r('div', { className: 'md:col-span-2 flex justify-end gap-4' },
                  editingEntryId && (
                    r('button', {
                      type: 'button',
                      onClick: handleCancelEdit,
                      className: 'flex items-center gap-2 px-6 py-3 bg-gray-500 text-white font-semibold rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-300 transition-all duration-200 transform hover:scale-105',
                      disabled: isLoading
                    },
                      r(XCircle, { size: 20 }),
                      'Cancelar'
                    )
                  ),
                  r('button', {
                    type: 'submit',
                    className: `flex items-center gap-2 px-6 py-3 font-semibold rounded-full shadow-lg focus:outline-none focus:ring-4 transition-all duration-200 transform hover:scale-105 ${
                      editingEntryId
                        ? 'bg-orange-500 text-white hover:bg-orange-600 focus:ring-orange-300'
                        : 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-300'
                    }`,
                    disabled: isLoading
                  },
                    editingEntryId
                      ? r(Edit, { size: 20 })
                      : r(PlusCircle, { size: 20 }),
                    editingEntryId ? 'Guardar Cambios' : 'Agregar Incidencia'
                  )
                )
              )
            ),
    
            // Sección de búsqueda y tabla de resultados
            r('div', { className: 'bg-white rounded-2xl shadow-xl p-6 sm:p-8 transition-all duration-300 hover:shadow-2xl' },
              r('div', { className: 'flex flex-col sm:flex-row justify-between items-center mb-6' },
                r('h2', { className: 'text-2xl font-semibold text-gray-700 mb-4 sm:mb-0' }, 'Registros guardados'),
                r('div', { className: 'flex items-center gap-4 w-full sm:w-auto' },
                  r('div', { className: 'relative w-full' },
                    r('input', {
                      type: 'text',
                      placeholder: 'Buscar por fecha, nivel o incidencia...',
                      value: searchQuery,
                      onChange: (e) => setSearchQuery(e.target.value),
                      className: 'w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors',
                      disabled: isLoading
                    }),
                    r(Search, { className: 'absolute left-3 top-1/2 -translate-y-1/2 text-gray-400', size: 20 })
                  ),
                  r('button', {
                    onClick: handleExportPdf,
                    disabled: isExporting || isLoading || filteredEntries.length === 0,
                    className: `flex items-center gap-2 px-4 py-2 font-semibold rounded-lg shadow-md transition-all duration-200 ${
                      isExporting || isLoading || filteredEntries.length === 0
                        ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
                        : 'bg-green-600 text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300'
                    }`
                  },
                    isExporting
                      ? r('svg', { className: 'animate-spin h-5 w-5 text-white', xmlns: 'http://www.w3.org/2000/svg', fill: 'none', viewBox: '0 0 24 24' },
                          r('circle', { className: 'opacity-25', cx: '12', cy: '12', r: '10', stroke: 'currentColor', strokeWidth: '4' }),
                          r('path', { className: 'opacity-75', fill: 'currentColor', d: 'M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z' })
                        )
                      : r(Fragment, null,
                          r(FileText, { size: 20 }),
                          `Exportar (${filteredEntries.length})`
                        )
                  )
                )
              ),
              
              // Muestra el mensaje de error de exportación
              exportError && r('div', { className: 'mt-4 text-center text-red-500 flex items-center justify-center gap-2' }, 
                r(XCircle, { size: 20 }),
                `Error: La librería de exportación a PDF no se ha cargado correctamente.`
              ),

              // Tabla de resultados
              isLoading ? (
                r('div', { className: 'flex items-center justify-center p-8 text-gray-500' },
                  r(Loader2, { className: 'animate-spin mr-2', size: 24 }),
                  'Cargando registros...'
                )
              ) : (
                r('div', { className: 'overflow-x-auto rounded-lg border border-gray-200' },
                  filteredEntries.length > 0 ? (
                    r('table', { className: 'min-w-full divide-y divide-gray-200' },
                      r('thead', { className: 'bg-slate-100' },
                        r('tr', null,
                          r('th', { scope: 'col', className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Fecha'),
                          r('th', { scope: 'col', className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Nivel'),
                          r('th', { scope: 'col', className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Tipo'),
                          r('th', { scope: 'col', className: 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Incidencias'),
                          r('th', { scope: 'col', className: 'px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider' }, 'Acción')
                        )
                      ),
                      r('tbody', { className: 'bg-white divide-y divide-gray-200' },
                        filteredEntries.map((entry) => (
                          r('tr', { key: entry.id, className: 'hover:bg-slate-50 transition-colors' },
                            r('td', { className: 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900' }, entry.fecha),
                            r('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-600' }, entry.nivel),
                            r('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-600' }, entry.tipo),
                            r('td', { className: 'px-6 py-4 text-sm text-gray-600 max-w-xs md:max-w-md overflow-hidden text-ellipsis' }, entry.incidencias),
                            r('td', { className: 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center justify-end gap-2' },
                              r('button', {
                                onClick: () => handleEdit(entry),
                                className: 'text-blue-500 hover:text-blue-700 transition-colors focus:outline-none'
                              },
                                r(Edit, { size: 18 })
                              ),
                              r('button', {
                                onClick: () => handleDelete(entry.id),
                                className: 'text-red-500 hover:text-red-700 transition-colors focus:outline-none'
                              },
                                r(Trash2, { size: 18 })
                              )
                            )
                          )
                        ))
                      )
                    )
                  ) : (
                    r('p', { className: 'text-center text-gray-500 p-8' }, 'No hay registros para mostrar. ¡Agrega una nueva incidencia!')
                  )
                )
              )
            )
          )
        )
      );
    };

    // Renderiza la aplicación
    const root = d(document.getElementById('root'));
    root.render(r(App));
  </script>
</head>
<body>
  <div id="root"></div>
</body>
</html>
